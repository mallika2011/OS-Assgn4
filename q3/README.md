# Q3 Ober Cab Services

## Usage

```bash
    <n: number of cabs>
    <m: number of riders>
    <k: number of servers>
```

The program then randomly generates the following for the m riders:

* Arrival time
* Cab type
* Max Wait Time
* Ride time

(The above can also be user generated by using the alternate prompt function)

## Important funcitons used

* void makePayment(ll no)
The particular rider who has just exited waits on the payment semaphore. If there is a payment server, he pays and leaves thus signalling the payment semaphore (posting to it from the book cab function). The value of the payment semaphore is initalised to 0.

* void *bookPoolCab(void *a)
Invoked whenever a rider requests a pool cab. The function first checks for if there is a currently riding pool cab with a single occupancy. If so, place the rider there. Else, the function then creates two threads.
  * void *forPoolCheck(void *a)
  This funciton constantly polls for whether a pool cab with a single occupancy can be found before timeout.
  
  * void *forTimeoutCheck(void *a)
  This function waits on the cabs semaphore using timedwaiting.

    Accordingly if either a fresh cab or a pool cab with single occupancy is found, the new rider obtains that cab.

* void *bookPremierCab(void *a)
Invoked when a rider requests a premier cab. The function simply waits on the cabs semaphore and updates the allCabs array of structs if and when a fresh cab is found.

## Brief Explanation

* Each rider is a thread running independently. As an when a rider requests for a cab the appropriate functions are called.
```c
for (ll i = 0; i < m; i++)
    {
        poolFlag[i] = 0;
        timeoutFlag[i] = 0;
        if (args[i].type == 1)
            pthread_create(&riderThread[i], NULL, bookPremierCab, &args[i]);
        else if (args[i].type == 2)
            pthread_create(&riderThread[i], NULL, bookPoolCab, &args[i]);
    }
```

* The cabs are an array of structure type variables.
```c
struct allCabs
{
    int type;      // premier =1, pool =2
    int occupancy; // 0 no riders, 1 one rider, 2 two riders
} allCabs[1000];
```

* There are two types of cabs 1:Premier 2:Pool

* Each cab can have an occupancy of 0,1,2 (Premier can have only 0/1)

* If a single occupancy pool cab isn't found when a rider requests for it, two threads are created. On which polls on whether a single occupancy pool cab is found and the other which checks on the MaxWaitTime.
```c
  if (assigned == 1)
        ;
    else
    {
        //create one thread to check on the timeout
        pthread_create(&timeoutThread, NULL, forTimeoutCheck, (void *)riderDetails);
        //create one thread to check ont the pool status
        pthread_create(&poolThread, NULL, forPoolCheck, (void *)riderDetails);

        //busy wait on the threads' result
        while (poolFlag[passengerNumber] == 0 && timeoutFlag[passengerNumber] == 0)
            ;
    }
```

* Payments are done once the ride finishes. Each payment transaction takes 2s.
